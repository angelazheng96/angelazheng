---
import "../styles/global.css";

import Layout from "../layouts/Layout.astro";
import Banner from "../components/Banner.astro";

import GalleryImage from "../components/GalleryImage.astro";
import galleryData from "../data/gallery.json";

// Import image modules eagerly so they exist at build/preview time
const imported = import.meta.glob(
  "../images/gallery/*.{JPG,jpg,jpeg,png,gif,webp}",
  { eager: true },
);

// Normalize to { file: ImageModule, name: "filename.ext" }
const imageEntries = Object.entries(imported).map(([path, mod]) => ({
  file: (mod as any).default ?? mod,
  name: path.split("/").pop()?.toLowerCase() || "",
}));

const byName = new Map(imageEntries.map((e) => [e.name, e.file]));

// Map JSON â†’ image module. If meta.filename is missing, fall back by index.
const gallery = galleryData
  .map((meta, i) => {
    const fname = meta.filename?.toLowerCase();
    const fileObj = fname ? byName.get(fname) : imageEntries[i]?.file;
    return fileObj ? { ...meta, filePath: fileObj } : null;
  })
  .filter(Boolean);

// Shuffle the array of images with metadata
for (let i = gallery.length - 1; i > 0; i--) {
  const j = Math.floor(Math.random() * (i + 1));
  [gallery[i], gallery[j]] = [gallery[j], gallery[i]];
}
---

<Layout title="Gallery">
  <Banner>
    <h1
      class="text-4xl md:text-5xl font-medium text-center text-eggplant dark:text-lilac"
    >
      Gallery
    </h1>
  </Banner>
  <div
    class="mx-auto mt-6 md:mt-8 mb-4 max-w-3xl text-center text-base md:text-lg px-4"
  >
    ðŸ“¸ I like taking pictures of sunsets! (...and other things too)
  </div>

  <!-- Responsive masonry grid -->
  <div
    class="columns-1 sm:columns-2 md:columns-3 lg:columns-4 gap-2 space-y-2 p-2 md:p-4"
  >
    {
      gallery.map((image) => (
        <GalleryImage
          filePath={image.filePath}
          description={image.description}
          location={image.location}
          date={image.date}
        />
      ))
    }
  </div>

  <!-- Quote section -->
  <div class="mx-auto my-4 md:my-10 max-w-3xl grid grid-cols-1 gap-4 px-4">
    <div class="text-center text-base md:text-lg">
      You made it to the end! :D Here's a quote I really like:
      <div
        class="p-3 md:p-4 rounded-lg mt-2 bg-linear-90 from-salmon/25 via-lilac/25 to-aquamarine/25 dark:from-rose/25 dark:via-eggplant/25 dark:to-teal/25"
      >
        <blockquote>
          <p class="mb-3 text-sm md:text-base">
            And my heart swells at the silly, simple, human fact that when we
            stumble upon something beautiful, our first instinct is to show it
            to the people we love. It's what we do with pretty seashells on a
            beach, a radiant sunset, a rare bird flitting through the trees, a
            herd of wild horses grazing in the countryside. <i>Look</i>, we say,
            saving these little pieces of beauty for each other. <i>
              Do you see it too? Isn't the world such a strange, lovely,
              breathtaking place?</i
            >
          </p>
          <a
            href="https://www.annliang.com/"
            target="_blank"
            class="text-xs md:text-sm hover:text-eggplant dark:hover:text-lilac"
            >â€” Ann Liang, Never Thought I'd End Up Here, pg. 284</a
          >
        </blockquote>
      </div>
    </div>
  </div>
</Layout>
